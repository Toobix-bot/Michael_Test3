<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>KI Story-Weber – Interaktives Erzählen</title>
    <meta name="description" content="Eine clientseitige KI-Story-Engine, die Autor, Erzähler, Leser und Figur zugleich spielt." />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="app-header">
  <h1>KI Story‑Weber</h1>
  <p class="sub">Autor • Erzähler • Leser • Figur – alles im Browser, keine Server nötig.</p>
    </header>

    <main class="layout">
  <section class="panel controls">
        <nav class="tabs">
          <button class="tab active" data-tab="start">Start</button>
          <button class="tab" data-tab="profile">Profil & Laden</button>
          <button class="tab" data-tab="settings">Einstellungen</button>
        </nav>
        <div class="tab-panel active" data-tab-panel="start">
        <div class="row">
          <label for="viewMode">Ansicht</label>
          <select id="viewMode">
            <option value="simple" selected>Einfach</option>
            <option value="advanced">Erweitert</option>
          </select>
        </div>
        <div class="row">
          <label for="seed">Idee/Prompt</label>
          <input id="seed" placeholder="z.B. Nebel über einer verlassenen Küstenstadt" />
        </div>
        <div class="row">
          <div class="chips">
            <button class="chip promptchip" data-seed="Ein Leuchtturm blinkt unregelmäßig – SOS?" data-genre="mystery">Mystery: Leuchtturm‑SOS</button>
            <button class="chip promptchip" data-seed="Ein verborgener Pfad im alten Wald öffnet sich nur bei Regen." data-genre="fantasy">Fantasy: Regenpfad</button>
            <button class="chip promptchip" data-seed="Ein Forschungsschiff empfängt ein Signal aus der Zukunft." data-genre="sci-fi">Sci‑Fi: Zukunftssignal</button>
            <button class="chip promptchip advanced" data-seed="Release in 2 Stunden, ein Test flackert – was nun?" data-genre="mystery">Meta: Flaky Test</button>
            <button class="chip promptchip advanced" data-seed="Eine Stadt lebt von Erinnerungen als Währung." data-genre="drama">Drama: Erinnerungsmarkt</button>
            <button class="chip promptchip" data-seed="Ein Radio spielt eine Sendung, die erst morgen ausgestrahlt wird." data-genre="noir">Noir: Spätsendung</button>
            <button class="chip promptchip" data-seed="Die Türen verriegeln sich von allein, Flüstern im dunklen Haus." data-genre="horror">Horror: Hausflüstern</button>
          </div>
        </div>
        <div class="row">
          <label for="genre">Genre</label>
          <select id="genre">
            <option value="mystery">Mystery</option>
            <option value="fantasy">Fantasy</option>
            <option value="sci-fi">Science-Fiction</option>
            <option value="abenteuer">Abenteuer</option>
            <option value="drama">Drama</option>
            <option value="noir">Noir</option>
            <option value="horror">Horror</option>
          </select>
        </div>
        <div class="btn-row">
          <button id="startBtn" class="primary">Neue Geschichte starten</button>
        </div>
        <details class="hint">
          <summary>Was ist das?</summary>
          <p>
            Diese Seite nutzt eine leichte, regelbasierte Story-Engine. Sie plant Beats (Autor), wählt Handlungen nach
            Eigenschaften der Figuren (Figur), erzählt stilistisch (Erzähler) und kommentiert gelegentlich (Leser).
            Alles passiert lokal im Browser – keine externen KI‑APIs.
          </p>
        </details>
        </div>
        <div class="tab-panel" data-tab-panel="profile">
        <h3 style="margin:6px 0 8px;font-size:1rem;color:var(--muted)">Profil & Fortschritt</h3>
        <div id="profileBox" class="profile">
          <div class="row"><span id="pRuns"></span></div>
          <div class="row"><span id="pBest"></span></div>
          <div class="row"><span id="pPoints"></span></div>
          <div class="row advanced"><span id="pPerks"></span></div>
          <div class="row advanced"><span id="pRelics"></span></div>
          <div class="row advanced"><span id="pAch"></span></div>
          <div class="row advanced"><span id="pTitles"></span></div>
          <div class="row">
            <label><input type="checkbox" id="idleToggle" checked /> Idle‑Punkte sammeln (+1/30s, nur im Vordergrund)</label>
          </div>
          <div class="btn-row advanced">
            <button id="exportBtn">Export</button>
            <label class="filebtn">
              Import
              <input id="importInput" type="file" accept="application/json" hidden />
            </label>
            <button id="resetProfileBtn" class="ghost">Profil zurücksetzen</button>
            <button id="resetPersonaBtn" class="ghost">Persona zurücksetzen</button>
          </div>
        </div>
        <details class="hint advanced">
          <summary>Heimat & Laden</summary>
          <div class="row">Tausche Punkte gegen kleine Start‑Boni:</div>
          <div class="btn-row">
            <button id="buyOptimistBtn">Perk „Optimist” (50 P)</button>
            <button id="buyCalmBtn">Perk „Klarer Kopf” (40 P)</button>
            <button id="buyRelicBtn" class="ghost">Zufalls‑Relikt (60 P)</button>
          </div>
          <small style="color:var(--muted)">Punkte sammelst du durch abgeschlossene Runs (abhängig von Score & Kapiteln).</small>
        </details>
        <details class="hint advanced">
          <summary>CarryOver-Startoptionen</summary>
          <div class="row">
            <label for="startRelic">Start-Relikt (optional)</label>
            <select id="startRelic">
              <option value="">Automatisch</option>
            </select>
          </div>
          <div class="row">
            <label for="startCast">Startfigur bevorzugen (optional)</label>
            <input id="startCast" placeholder="Name (falls vorhanden)" />
          </div>
        </details>
        </div>
        <div class="tab-panel" data-tab-panel="settings">
        <div class="row advanced">
          <label for="aiProfile">KI-Profil (Vorschläge)</label>
          <select id="aiProfile">
            <option value="balanced" selected>Balanciert</option>
            <option value="defensive">Defensiv</option>
            <option value="aggressive">Offensiv</option>
          </select>
        </div>
        <div class="row advanced">
          <label for="aiProvider">KI-Lab Provider</label>
          <select id="aiProvider">
            <option value="none" selected>Keiner (rein lokal)</option>
            <option value="mock">Mock (Demo)</option>
            <option value="gpu">WebGPU (experimentell)</option>
          </select>
        </div>
        <div class="row advanced">
          <label for="freedom">Kreative Freiheit <small id="freedomVal" style="color:var(--muted)"></small></label>
          <input id="freedom" type="range" min="0" max="100" value="40" />
        </div>
        <div class="row advanced">
          <label for="mode">Modus</label>
          <select id="mode">
            <option value="story" selected>Geschichte</option>
          </select>
        </div>
        <div class="row advanced">
          <label for="complexity">Kapitel-Länge</label>
          <select id="complexity">
            <option value="short">Kurz</option>
            <option value="normal" selected>Mittel</option>
            <option value="long">Lang</option>
          </select>
        </div>
        <div class="row advanced">
          <label for="perspective">Leser-Interjektionen</label>
          <select id="perspective">
            <option value="auto">Gelegentlich</option>
            <option value="off">Aus</option>
            <option value="on">Oft</option>
          </select>
        </div>
        <div class="row advanced">
          <label><input type="checkbox" id="peacefulMode" /> Friedlicher Modus (weniger Rückschläge, geringere Gefahr/Spannung)</label>
        </div>
        <div class="btn-row">
          <button id="saveBtn" class="advanced">Speichern</button>
          <button id="loadBtn" class="advanced">Laden</button>
          <button id="resetBtn" class="ghost advanced">Zurücksetzen</button>
        </div>
        <details class="hint advanced">
          <summary>Einstellungen erklärt</summary>
          <ul>
            <li><strong>Genre</strong>: Bestimmt Ton, Motive und Vokabular.</li>
            <li><strong>Kreative Freiheit</strong>: Je höher, desto mehr überraschende Beats und zusätzliche Optionen.</li>
            <li><strong>Modus</strong>: Geschichte (klassisch) oder Meta (Website/Programmierung als „Story“).</li>
            <li><strong>Kapitel-Länge</strong>: Kurz/Mittel/Lang steuert Beats pro Kapitel und die Größe des Casts.</li>
            <li><strong>Leser-Interjektionen</strong>: Schaltet kurze Kommentare einer Leser‑Stimme ein/aus.</li>
            <li><strong>Profil</strong>: Perks/Relikte geben kleine Start‑Boni; Fortschritt bleibt zwischen Runs erhalten.</li>
            <li><strong>KI-Profil</strong>: Definiert die Vorschlags-Tendenz (defensiv/balanciert/offensiv). Die Persona lernt aus vergangenen Runs.</li>
            <li><strong>WebGPU</strong>: Benötigt HTTPS (z. B. GitHub Pages) und einen aktuellen Browser.</li>
          </ul>
        </details>
        </div>
      </section>

      <section class="panel story">
        <div id="menuOverlay" class="overlay hidden">
          <div class="overlay-card">
            <h2>Hauptmenü</h2>
            <div id="menuSummary" class="insights-box" style="text-align:left"></div>
            <div class="btn-col">
              <button id="menuContinue" class="primary">Fortsetzen</button>
              <button id="menuNew">Neuer Run</button>
              <button id="menuSettings" class="ghost">Einstellungen</button>
            </div>
            <small style="color:var(--muted)">Tipp: Einstellungen links anpassen. Fortsetzen lädt gespeicherten Stand, falls vorhanden.</small>
          </div>
        </div>
        <div class="statusbar">
          <span id="statusChapter"></span>
          <span id="statusWorld"></span>
          <span id="statusCast"></span>
          <button id="menuBtn" class="ghost">Menü</button>
        </div>
    <div class="world-bars advanced">
          <div class="bar"><span>Hoffnung</span><div class="track"><div class="fill hope" id="barHope"></div></div></div>
          <div class="bar"><span>Spannung</span><div class="track"><div class="fill tension" id="barTension"></div></div></div>
          <div class="bar"><span>Gefahr</span><div class="track"><div class="fill threat" id="barThreat"></div></div></div>
        </div>
    <div class="insights advanced">
          <div>
            <strong>KI-Mitspieler</strong>
            <div class="btn-row">
              <button id="aiSuggestBtn">Vorschlag</button>
      <button id="aiAutoBtn" class="ghost advanced">Auto (1 Schritt)</button>
            </div>
          </div>
          <div>
            <strong>Hinweise</strong>
            <div id="insightsBox" class="insights-box"></div>
          </div>
        </div>
        <div id="story" class="story-out"></div>

        <div id="choices" class="choices"></div>

        <div class="freeform">
          <input id="freeInput" placeholder="Eigene Aktion … z. B. 'untersuchen', 'konfrontieren', 'fragen' oder /untersuchen" />
          <button id="actBtn" class="secondary">Ausführen</button>
        </div>
        <div class="chips advanced">
          <button class="chip" data-free="/untersuchen Bereich">Untersuchen</button>
          <button class="chip" data-free="/konfrontieren Figur">Konfrontieren</button>
          <button class="chip" data-free="/fragen Hinweis">Fragen</button>
          <button class="chip" data-free="/verbündeter suchen">Verbündeten suchen</button>
          <button class="chip" data-free="/rückzug">Rückzug</button>
          <!-- Meta-Befehle vorerst verborgen -->
        </div>
        <div class="hint advanced" style="margin-top:6px">
          Tipp: Verwende starke Verben oder Slash‑Befehle. Die KI interpretiert <code>/untersuchen</code> als Fortschritt,
          <code>/konfrontieren</code> als Enthüllung (mehr Spannung), <code>/rückzug</code>/<code>/rollback</code> als Rückschritt (Risikoabbau).
        </div>
      </section>
  <div id="toasts"></div>
    </main>

    <footer class="app-footer">
      <small>Clientseitig • Open Web • GitHub Pages‑freundlich</small>
    </footer>

    <script type="module">
  import { StoryEngine } from './src/engine.mjs';
  import { loadProfile, saveProfile, resetProfile, exportProfile, importProfile, applyCarryoverOptions, applyRunResultToProfile, purchasePerk, purchaseRelic } from './src/profile.mjs';
  import { getProvider } from './src/ai/providers.mjs';

      const els = {
        seed: document.getElementById('seed'),
  tabs: Array.from(document.querySelectorAll('.tab')),
  tabPanels: Array.from(document.querySelectorAll('.tab-panel')),
  viewMode: document.getElementById('viewMode'),
        genre: document.getElementById('genre'),
  freedom: document.getElementById('freedom'),
  freedomVal: document.getElementById('freedomVal'),
  aiProfile: document.getElementById('aiProfile'),
  aiProvider: document.getElementById('aiProvider'),
  mode: document.getElementById('mode'),
  complexity: document.getElementById('complexity'),
        perspective: document.getElementById('perspective'),
  peacefulMode: document.getElementById('peacefulMode'),
        startBtn: document.getElementById('startBtn'),
        saveBtn: document.getElementById('saveBtn'),
        loadBtn: document.getElementById('loadBtn'),
        resetBtn: document.getElementById('resetBtn'),
  aiSuggestBtn: document.getElementById('aiSuggestBtn'),
  aiAutoBtn: document.getElementById('aiAutoBtn'),
  exportBtn: document.getElementById('exportBtn'),
  importInput: document.getElementById('importInput'),
  resetProfileBtn: document.getElementById('resetProfileBtn'),
  resetPersonaBtn: document.getElementById('resetPersonaBtn'),
  pPoints: document.getElementById('pPoints'),
  pTitles: document.getElementById('pTitles'),
  startRelic: document.getElementById('startRelic'),
  startCast: document.getElementById('startCast'),
        story: document.getElementById('story'),
        choices: document.getElementById('choices'),
  statusChapter: document.getElementById('statusChapter'),
  statusWorld: document.getElementById('statusWorld'),
  statusCast: document.getElementById('statusCast'),
  barHope: document.getElementById('barHope'),
  barTension: document.getElementById('barTension'),
  barThreat: document.getElementById('barThreat'),
        freeInput: document.getElementById('freeInput'),
        actBtn: document.getElementById('actBtn'),
  insightsBox: document.getElementById('insightsBox'),
  menuOverlay: document.getElementById('menuOverlay'),
  menuContinue: document.getElementById('menuContinue'),
  menuNew: document.getElementById('menuNew'),
  menuSettings: document.getElementById('menuSettings'),
  menuBtn: document.getElementById('menuBtn'),
  menuSummary: document.getElementById('menuSummary'),
  toasts: document.getElementById('toasts'),
  buyOptimistBtn: document.getElementById('buyOptimistBtn'),
  buyCalmBtn: document.getElementById('buyCalmBtn'),
  buyRelicBtn: document.getElementById('buyRelicBtn'),
  idleToggle: document.getElementById('idleToggle'),
      };

    let engine = null;
  let profile = loadProfile();
  let provider = null;
  let idleTimer = null;

      function renderLog(log) {
        els.story.innerHTML = '';
        log.forEach(entry => {
          const p = document.createElement('p');
          p.textContent = entry;
          els.story.appendChild(p);
        });
        els.story.scrollTop = els.story.scrollHeight;
      }

      function renderChoices(choices) {
        els.choices.innerHTML = '';
        if (!choices || choices.length === 0) return;
        const seen = new Set();
        choices.forEach((c, idx) => {
          if (seen.has(c.title)) return; // Duplikate ausblenden
          seen.add(c.title);
          const btn = document.createElement('button');
          btn.className = 'choice';
          const eff = c.effects || {};
          const effTxt = [
            eff.hope ? `Hoffnung ${eff.hope>0?'+':''}${(eff.hope*100)|0}%` : null,
            eff.tension ? `Spannung ${eff.tension>0?'+':''}${(eff.tension*100)|0}%` : null,
            eff.threat ? `Gefahr ${eff.threat>0?'+':''}${(eff.threat*100)|0}%` : null,
          ].filter(Boolean).join(' · ');
          btn.textContent = c.title; // kompakter Text
          btn.title = effTxt || (c.risk ? `Risiko: ${c.risk}` : '');
          btn.addEventListener('click', () => {
            engine.next({ type: 'choice', index: idx });
          });
          els.choices.appendChild(btn);
        });
      }

      function renderProfile() {
        els.pRuns.textContent = `Runs gesamt: ${profile.totalRuns} · Kapitel gesamt: ${profile.totalChapters}`;
        els.pBest.textContent = `Bester Score: ${profile.bestScore}`;
  els.pPoints.textContent = `Punkte: ${profile.points ?? 0}`;
        els.pPerks.textContent = `Perks: ${profile.perks.join(', ') || '–'}`;
        els.pRelics.textContent = `Relikte: ${profile.relics.join(', ') || '–'}`;
        els.pAch.textContent = `Errungenschaften: ${profile.achievements.join(', ') || '–'}`;
        const title = computeTitles(profile);
        els.pTitles.textContent = title ? `Titel: ${title}` : '';
        // fill carryover dropdown
        const sel = els.startRelic;
  if (sel && sel.children.length <= 1) {
          (profile.relics||[]).forEach(r => {
            const o = document.createElement('option'); o.value = r; o.textContent = r; sel.appendChild(o);
          });
        }
  // enable/disable shop buttons (inline affordability checks)
  const pts = profile.points ?? 0;
  if (els.buyOptimistBtn) els.buyOptimistBtn.disabled = profile.perks.includes('Optimist') || pts < 50;
  if (els.buyCalmBtn) els.buyCalmBtn.disabled = profile.perks.includes('CalmMind') || pts < 40;
  if (els.buyRelicBtn) els.buyRelicBtn.disabled = pts < 60;
      }

      function renderInsights() {
        if (!engine) { els.insightsBox.textContent = ''; return; }
        const i = engine.getInsights();
        const dist = i.distribution;
        const sug = i.suggestion;
        const cast = i.castTraits.map(ct => `${ct.name}: ${ct.traits.join(', ')}`).join(' | ');
        const lines = [];
        lines.push(`Beats (Prognose): reveal ${(dist.reveal*100)|0}% · progress ${(dist.progress*100)|0}% · setback ${(dist.setback*100)|0}% · choice ${(dist.choice*100)|0}%`);
        lines.push(`Figuren: ${cast}`);
        if (sug?.ties?.length) {
          const names = sug.ties.map(t => t.title).join(' | ');
          lines.push(`Mehrere gute Optionen: ${names}`);
          lines.push(`Begründung: ${sug.rationale}`);
        }
        els.insightsBox.textContent = lines.join('\n');
      }

      function renderStatus(state) {
        els.statusChapter.textContent = `Kapitel ${state.chapter}/${state.maxChapters}`;
        const w = state.world;
        els.statusWorld.textContent = `Hoffnung ${(w.hope*100)|0}% · Spannung ${(w.tension*100)|0}% · Gefahr ${(w.threat*100)|0}%`;
        const cast = (state.cast||[]).map(c => `${c.name} (${c.role})`).join(', ');
        els.statusCast.textContent = `Figuren: ${cast}`;
  els.barHope.style.width = `${Math.round(w.hope*100)}%`;
  els.barTension.style.width = `${Math.round(w.tension*100)}%`;
  els.barThreat.style.width = `${Math.round(w.threat*100)}%`;
  renderInsights();
      }

      function boot() {
        const seed = (els.seed.value || '').trim() || 'Ein rätselhafter Fund in der Nacht';
        const genre = els.genre.value || 'mystery';
  const freedom = Math.max(0, Math.min(1, (Number(els.freedom.value)||0)/100));
  const mode = 'story';
        const complexity = els.complexity.value || 'normal';
        const readerMode = els.perspective.value || 'auto';
  const aiProfile = els.aiProfile.value || 'balanced';
  provider = getProvider(els.aiProvider.value);
  const carry = applyCarryoverOptions(profile);
        const startRelic = els.startRelic?.value || '';
        const startCastPref = (els.startCast?.value||'').trim();
  engine = new StoryEngine({ seed, genre, freedom, mode, complexity, readerMode, language: 'de', boosts: carry.boosts, explain: true, aiProfile, startRelic, startCastPref, stylePref: profile.stylePref, policy: profile.policy, peaceful: !!els.peacefulMode?.checked, onEnd: (result) => {
          profile = applyRunResultToProfile(profile, result);
          renderProfile();
          toast('Run abgeschlossen: Score '+result.score, 'ok');
        }});
        engine.onUpdate((state) => {
          renderLog(state.log);
          renderChoices(state.choices);
          renderStatus(state);
        });
        engine.start();
        toast('Neue Geschichte gestartet', 'info');
      }

      els.startBtn.addEventListener('click', boot);
      // tabs
      function switchTab(id){
        els.tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===id));
        els.tabPanels.forEach(p=>p.classList.toggle('active', p.dataset.tabPanel===id));
      }
      els.tabs.forEach(t=> t.addEventListener('click', ()=> switchTab(t.dataset.tab)) );
      els.actBtn.addEventListener('click', () => {
        const text = (els.freeInput.value || '').trim();
        if (!text) return;
        engine?.next({ type: 'free', text });
        els.freeInput.value = '';
      });
      document.addEventListener('click', (e) => {
        const t = e.target;
        if (t && t.classList && t.classList.contains('chip')) {
          const val = t.getAttribute('data-free') || '';
          els.freeInput.value = val;
        }
        if (t && t.classList && t.classList.contains('promptchip')) {
          const seed = t.getAttribute('data-seed') || '';
          const genre = t.getAttribute('data-genre') || '';
          if (seed) els.seed.value = seed;
          if (genre) els.genre.value = genre;
        }
      });
      els.saveBtn.addEventListener('click', () => {
        if (!engine) return;
        const save = engine.save();
        localStorage.setItem('ki-story-weber-save', JSON.stringify(save));
  refreshMenuFromSave();
  toast('Gespeichert', 'ok');
      });
      els.loadBtn.addEventListener('click', () => {
        const raw = localStorage.getItem('ki-story-weber-save');
        if (!raw) return;
        try {
          const data = JSON.parse(raw);
          els.freedom.value = String(Math.round((data.freedom ?? 0.4)*100));
          engine = new StoryEngine({ seed: data.seed, genre: data.genre, freedom: data.freedom, mode: data.mode, complexity: data.complexity, readerMode: data.readerMode, language: data.language });
          engine.onUpdate((state) => {
            renderLog(state.log);
            renderChoices(state.choices);
            renderStatus(state);
          });
          engine.load(data);
          refreshMenuFromSave();
          toast('Save geladen', 'ok');
        } catch (e) {
          console.error('Laden fehlgeschlagen', e);
          toast('Laden fehlgeschlagen', 'err');
        }
      });
      els.resetBtn.addEventListener('click', () => {
        engine = null;
        els.story.innerHTML = '';
        els.choices.innerHTML = '';
        document.title = 'KI Story-Weber – Interaktives Erzählen';
      });

      // menu
      const showMenu = () => els.menuOverlay.classList.remove('hidden');
      const hideMenu = () => els.menuOverlay.classList.add('hidden');
      const refreshMenuFromSave = () => {
        const raw = localStorage.getItem('ki-story-weber-save');
        if (!raw) {
          els.menuSummary.textContent = 'Kein gespeicherter Run.';
          els.menuContinue.setAttribute('disabled','');
          return;
        }
        try {
          const s = JSON.parse(raw);
          const seed = (s.seed||'').toString();
          const seedShort = seed.length>80 ? seed.slice(0,77)+'…' : seed;
          const world = s.world||{};
          const cast = (s.cast||[]).map(c=>c.name||c).join(', ');
          const lines = [];
          lines.push(`Genre: ${s.genre} · Modus: ${s.mode}`);
          lines.push(`Kapitel: ${s.chapter}/${s.maxChapters} · Schritt: ${s.step}`);
          lines.push(`Welt: Hoffnung ${(world.hope*100|0)||0}% · Spannung ${(world.tension*100|0)||0}% · Gefahr ${(world.threat*100|0)||0}%`);
          if (cast) lines.push(`Figuren: ${cast}`);
          if (seedShort) lines.push(`Idee: ${seedShort}`);
          els.menuSummary.textContent = lines.join('\n');
          els.menuContinue.removeAttribute('disabled');
        } catch {
          els.menuSummary.textContent = 'Kein gespeicherter Run.';
          els.menuContinue.setAttribute('disabled','');
        }
      };
      els.menuContinue.addEventListener('click', () => {
        const raw = localStorage.getItem('ki-story-weber-save');
        if (!raw) return;
        try {
          const data = JSON.parse(raw);
          els.freedom.value = String(Math.round((data.freedom ?? 0.4)*100));
          engine = new StoryEngine({ seed: data.seed, genre: data.genre, freedom: data.freedom, mode: data.mode, complexity: data.complexity, readerMode: data.readerMode, language: data.language });
          engine.onUpdate((state) => { renderLog(state.log); renderChoices(state.choices); renderStatus(state); });
          engine.load(data);
          hideMenu();
        } catch {}
      });
      els.menuNew.addEventListener('click', () => { hideMenu(); });
      els.menuSettings.addEventListener('click', () => { hideMenu(); });
      els.menuBtn.addEventListener('click', () => { refreshMenuFromSave(); showMenu(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !els.menuOverlay.classList.contains('hidden')) hideMenu(); });

      // show menu on load if save exists
      refreshMenuFromSave();
      if (localStorage.getItem('ki-story-weber-save')) showMenu();

      // AI co-player buttons
  els.aiSuggestBtn.addEventListener('click', async () => {
        renderInsights();
        // optional provider suggestion
        if (provider && provider.name !== 'none') {
          try {
            const st = engine?.getPublicState?.();
    const ps = await provider.suggest?.(st, st?.choices||[]);
            if (ps && typeof ps.index === 'number') {
              const title = st?.choices?.[ps.index]?.title || `Index ${ps.index}`;
              toast(`Provider: ${title}${ps.rationale?(' — '+ps.rationale):''}`, 'info');
            }
          } catch {}
        }
      });
  els.aiAutoBtn.addEventListener('click', async () => {
        const s = engine?.getInsights?.();
        if (s?.suggestion) {
          engine.next({ type: 'choice', index: s.suggestion.index });
        }
        else if (provider && provider.name !== 'none') {
          const st = engine?.getPublicState?.();
      const ps = await provider.suggest?.(st, st?.choices||[]);
      if (ps && typeof ps.index === 'number') engine.next({ type: 'choice', index: ps.index });
        }
      });

      // profile buttons
      els.exportBtn.addEventListener('click', () => exportProfile());
      els.importInput.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        profile = await importProfile(file);
        renderProfile();
      });
  els.resetProfileBtn.addEventListener('click', () => { resetProfile(); profile = loadProfile(); renderProfile(); toast('Profil zurückgesetzt','info'); });
  els.resetPersonaBtn.addEventListener('click', () => { profile.stylePref = { learn: true, accents: { insight: 0, bold: 0, caution: 0, momentum: 0, empathy: 0 } }; saveProfile(profile); renderProfile(); toast('Persona zurückgesetzt','info'); });

      // shop actions
      function makeRelicName() {
        const a = ['Stern','Nebel','Echo','Kern','Flamme','Pfad','Schlüssel','Spiegel','Knoten','Harfe'];
        const b = [' der Dämmerung',' des Nordwinds',' der Tiefe',' der Erinnerung',' des Aufbruchs',' des Flüsterns'];
        return (a[Math.floor(Math.random()*a.length)] + b[Math.floor(Math.random()*b.length)]);
      }
      els.buyOptimistBtn?.addEventListener('click', () => {
        const res = purchasePerk(profile, 'Optimist', 50);
        if (res.ok) { profile = res.profile; renderProfile(); toast('Gekauft: Optimist', 'ok'); saveProfile(profile); }
        else { toast(res.reason || 'Nicht genug Punkte', 'err'); }
      });
      els.buyCalmBtn?.addEventListener('click', () => {
        const res = purchasePerk(profile, 'CalmMind', 40);
        if (res.ok) { profile = res.profile; renderProfile(); toast('Gekauft: Klarer Kopf', 'ok'); saveProfile(profile); }
        else { toast(res.reason || 'Nicht genug Punkte', 'err'); }
      });
      els.buyRelicBtn?.addEventListener('click', () => {
        const name = makeRelicName();
        const res = purchaseRelic(profile, name, 60);
        if (res.ok) { profile = res.profile; renderProfile(); toast('Relikt erhalten: '+name, 'ok'); saveProfile(profile); }
        else { toast(res.reason || 'Nicht genug Punkte', 'err'); }
      });

      // toasts
      function toast(msg, kind='info', ms=2500){
        const t = document.createElement('div');
        t.className = `toast ${kind}`;
        t.textContent = msg;
        els.toasts.appendChild(t);
        setTimeout(()=>{ t.style.transition='opacity .2s'; t.style.opacity='0'; setTimeout(()=>t.remove(), 180); }, ms);
      }

      // titles by dominant accents across runs (simple)
      function computeTitles(p){
        // derive a fun title from achievements/perks/relic count
        const badges = [];
        if ((p.achievements||[]).includes('BeaconOfHope')) badges.push('Lichtbringer');
        if ((p.achievements||[]).includes('TamedTheStorm')) badges.push('Sturmzähmer');
        if ((p.achievements||[]).includes('LongJourney')) badges.push('Weitwanderer');
        if ((p.achievements||[]).includes('MarathonMind')) badges.push('Marathon-Geist');
        if ((p.achievements||[]).includes('WildImprov')) badges.push('Impro-Magier');
        if ((p.perks||[]).includes('Optimist')) badges.push('Optimist');
        if ((p.perks||[]).includes('CalmMind')) badges.push('Klarer Kopf');
        if (p.relics?.length>=5) badges.push('Sammler/in');
        return badges.join(' · ');
      }

      // initial render
  renderProfile();
  // idle points ticker
  function startIdle(){
    stopIdle();
    if (!els.idleToggle?.checked) return;
    idleTimer = setInterval(()=>{
      if (document.hidden) return; // only when tab focused
      profile.points = (profile.points||0) + 1;
      saveProfile(profile);
      renderProfile();
    }, 30000);
  }
  function stopIdle(){ if (idleTimer) { clearInterval(idleTimer); idleTimer = null; } }
  els.idleToggle?.addEventListener('change', ()=>{ if (els.idleToggle.checked) startIdle(); else stopIdle(); });
  startIdle();
  // view mode toggle
  const savedView = localStorage.getItem('ki-story-view') || 'simple';
  if (els.viewMode) {
    els.viewMode.value = savedView;
    document.body.classList.toggle('simple', savedView === 'simple');
    els.viewMode.addEventListener('change', () => {
      const mode = els.viewMode.value;
      localStorage.setItem('ki-story-view', mode);
      document.body.classList.toggle('simple', mode === 'simple');
    });
  }
  const updateFreedomLabel = () => { els.freedomVal.textContent = `${els.freedom.value}%`; };
  els.freedom.addEventListener('input', updateFreedomLabel);
  updateFreedomLabel();
    </script>
  </body>
  </html>
