<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>KI Story-Weber – Interaktives Erzählen</title>
    <meta name="description" content="Eine clientseitige KI-Story-Engine, die Autor, Erzähler, Leser und Figur zugleich spielt." />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="app-header">
      <h1>KI Story‑Weber</h1>
      <p class="sub">Autor • Erzähler • Leser • Figur – alles im Browser, keine Server nötig.</p>
    </header>

    <main class="layout">
  <section class="panel controls">
        <div class="row">
          <label for="seed">Idee/Prompt</label>
          <input id="seed" placeholder="z.B. Nebel über einer verlassenen Küstenstadt" />
        </div>
        <div class="row">
          <label for="genre">Genre</label>
          <select id="genre">
            <option value="mystery">Mystery</option>
            <option value="fantasy">Fantasy</option>
            <option value="sci-fi">Science-Fiction</option>
            <option value="abenteuer">Abenteuer</option>
            <option value="drama">Drama</option>
          </select>
        </div>
        <div class="row">
          <label for="freedom">Kreative Freiheit <small id="freedomVal" style="color:var(--muted)"></small></label>
          <input id="freedom" type="range" min="0" max="100" value="40" />
        </div>
        <div class="row">
          <label for="mode">Modus</label>
          <select id="mode">
            <option value="story">Geschichte</option>
            <option value="meta">Meta (Website/Programmierer/Nutzer)</option>
          </select>
        </div>
        <div class="row">
          <label for="complexity">Kapitel-Länge</label>
          <select id="complexity">
            <option value="short">Kurz</option>
            <option value="normal" selected>Mittel</option>
            <option value="long">Lang</option>
          </select>
        </div>
        <div class="row">
          <label for="perspective">Leser-Interjektionen</label>
          <select id="perspective">
            <option value="auto">Gelegentlich</option>
            <option value="off">Aus</option>
            <option value="on">Oft</option>
          </select>
        </div>
        <div class="btn-row">
          <button id="startBtn" class="primary">Neue Geschichte starten</button>
          <button id="saveBtn">Speichern</button>
          <button id="loadBtn">Laden</button>
          <button id="resetBtn" class="ghost">Zurücksetzen</button>
        </div>
        <details class="hint">
          <summary>Was ist das?</summary>
          <p>
            Diese Seite nutzt eine leichte, regelbasierte Story-Engine. Sie plant Beats (Autor), wählt Handlungen nach
            Eigenschaften der Figuren (Figur), erzählt stilistisch (Erzähler) und kommentiert gelegentlich (Leser).
            Alles passiert lokal im Browser – keine externen KI‑APIs.
          </p>
        </details>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:10px 0" />
        <h3 style="margin:6px 0 8px;font-size:1rem;color:var(--muted)">Profil & Fortschritt</h3>
        <div id="profileBox" class="profile">
          <div class="row"><span id="pRuns"></span></div>
          <div class="row"><span id="pBest"></span></div>
          <div class="row"><span id="pPerks"></span></div>
          <div class="row"><span id="pRelics"></span></div>
          <div class="row"><span id="pAch"></span></div>
          <div class="btn-row">
            <button id="exportBtn">Export</button>
            <label class="filebtn">
              Import
              <input id="importInput" type="file" accept="application/json" hidden />
            </label>
            <button id="resetProfileBtn" class="ghost">Profil zurücksetzen</button>
          </div>
        </div>
      </section>

      <section class="panel story">
        <div class="statusbar">
          <span id="statusChapter"></span>
          <span id="statusWorld"></span>
          <span id="statusCast"></span>
        </div>
        <div class="world-bars">
          <div class="bar"><span>Hoffnung</span><div class="track"><div class="fill hope" id="barHope"></div></div></div>
          <div class="bar"><span>Spannung</span><div class="track"><div class="fill tension" id="barTension"></div></div></div>
          <div class="bar"><span>Gefahr</span><div class="track"><div class="fill threat" id="barThreat"></div></div></div>
        </div>
        <div class="insights">
          <div>
            <strong>KI-Mitspieler</strong>
            <div class="btn-row">
              <button id="aiSuggestBtn">Vorschlag</button>
              <button id="aiAutoBtn" class="ghost">Auto (1 Schritt)</button>
            </div>
          </div>
          <div>
            <strong>Hinweise</strong>
            <div id="insightsBox" class="insights-box"></div>
          </div>
        </div>
        <div id="story" class="story-out"></div>

        <div id="choices" class="choices"></div>

        <div class="freeform">
          <input id="freeInput" placeholder="Eigene Aktion / Wendung vorschlagen…" />
          <button id="actBtn" class="secondary">Ausführen</button>
        </div>
      </section>
    </main>

    <footer class="app-footer">
      <small>Clientseitig • Open Web • GitHub Pages‑freundlich</small>
    </footer>

    <script type="module">
  import { StoryEngine } from './src/engine.mjs';
  import { loadProfile, saveProfile, resetProfile, exportProfile, importProfile, applyCarryoverOptions, applyRunResultToProfile } from './src/profile.mjs';

      const els = {
        seed: document.getElementById('seed'),
        genre: document.getElementById('genre'),
  freedom: document.getElementById('freedom'),
  freedomVal: document.getElementById('freedomVal'),
  mode: document.getElementById('mode'),
  complexity: document.getElementById('complexity'),
        perspective: document.getElementById('perspective'),
        startBtn: document.getElementById('startBtn'),
        saveBtn: document.getElementById('saveBtn'),
        loadBtn: document.getElementById('loadBtn'),
        resetBtn: document.getElementById('resetBtn'),
  aiSuggestBtn: document.getElementById('aiSuggestBtn'),
  aiAutoBtn: document.getElementById('aiAutoBtn'),
  exportBtn: document.getElementById('exportBtn'),
  importInput: document.getElementById('importInput'),
  resetProfileBtn: document.getElementById('resetProfileBtn'),
        story: document.getElementById('story'),
        choices: document.getElementById('choices'),
  statusChapter: document.getElementById('statusChapter'),
  statusWorld: document.getElementById('statusWorld'),
  statusCast: document.getElementById('statusCast'),
  barHope: document.getElementById('barHope'),
  barTension: document.getElementById('barTension'),
  barThreat: document.getElementById('barThreat'),
        freeInput: document.getElementById('freeInput'),
        actBtn: document.getElementById('actBtn'),
  insightsBox: document.getElementById('insightsBox'),
      };

      let engine = null;
  let profile = loadProfile();

      function renderLog(log) {
        els.story.innerHTML = '';
        log.forEach(entry => {
          const p = document.createElement('p');
          p.textContent = entry;
          els.story.appendChild(p);
        });
        els.story.scrollTop = els.story.scrollHeight;
      }

      function renderChoices(choices) {
        els.choices.innerHTML = '';
        if (!choices || choices.length === 0) return;
        choices.forEach((c, idx) => {
          const btn = document.createElement('button');
          btn.className = 'choice';
          const eff = c.effects || {};
          const effTxt = [
            eff.hope ? `Hoffnung ${eff.hope>0?'+':''}${(eff.hope*100)|0}%` : null,
            eff.tension ? `Spannung ${eff.tension>0?'+':''}${(eff.tension*100)|0}%` : null,
            eff.threat ? `Gefahr ${eff.threat>0?'+':''}${(eff.threat*100)|0}%` : null,
          ].filter(Boolean).join(' · ');
          const accents = (c.accents||[]).map(a=>`#${a}`).join(' ');
          btn.textContent = effTxt ? `${c.title} — ${c.risk||'?'} ${accents}` : `${c.title} ${accents}`;
          btn.title = effTxt || '';
          btn.addEventListener('click', () => {
            engine.next({ type: 'choice', index: idx });
          });
          els.choices.appendChild(btn);
        });
      }

      function renderProfile() {
        els.pRuns.textContent = `Runs gesamt: ${profile.totalRuns} · Kapitel gesamt: ${profile.totalChapters}`;
        els.pBest.textContent = `Bester Score: ${profile.bestScore}`;
        els.pPerks.textContent = `Perks: ${profile.perks.join(', ') || '–'}`;
        els.pRelics.textContent = `Relikte: ${profile.relics.join(', ') || '–'}`;
        els.pAch.textContent = `Errungenschaften: ${profile.achievements.join(', ') || '–'}`;
      }

      function renderInsights() {
        if (!engine) { els.insightsBox.textContent = ''; return; }
        const i = engine.getInsights();
        const dist = i.distribution;
        const sug = i.suggestion;
        const cast = i.castTraits.map(ct => `${ct.name}: ${ct.traits.join(', ')}`).join(' | ');
        const lines = [];
        lines.push(`Beats (Prognose): reveal ${(dist.reveal*100)|0}% · progress ${(dist.progress*100)|0}% · setback ${(dist.setback*100)|0}% · choice ${(dist.choice*100)|0}%`);
        lines.push(`Figuren: ${cast}`);
        if (sug?.ties?.length) {
          const names = sug.ties.map(t => t.title).join(' | ');
          lines.push(`Mehrere gute Optionen: ${names}`);
          lines.push(`Begründung: ${sug.rationale}`);
        }
        els.insightsBox.textContent = lines.join('\n');
      }

      function renderStatus(state) {
        els.statusChapter.textContent = `Kapitel ${state.chapter}/${state.maxChapters}`;
        const w = state.world;
        els.statusWorld.textContent = `Hoffnung ${(w.hope*100)|0}% · Spannung ${(w.tension*100)|0}% · Gefahr ${(w.threat*100)|0}%`;
        const cast = (state.cast||[]).map(c => `${c.name} (${c.role})`).join(', ');
        els.statusCast.textContent = `Figuren: ${cast}`;
  els.barHope.style.width = `${Math.round(w.hope*100)}%`;
  els.barTension.style.width = `${Math.round(w.tension*100)}%`;
  els.barThreat.style.width = `${Math.round(w.threat*100)}%`;
  renderInsights();
      }

      function boot() {
        const seed = (els.seed.value || '').trim() || 'Ein rätselhafter Fund in der Nacht';
        const genre = els.genre.value || 'mystery';
  const freedom = Math.max(0, Math.min(1, (Number(els.freedom.value)||0)/100));
        const mode = els.mode.value || 'story';
        const complexity = els.complexity.value || 'normal';
        const readerMode = els.perspective.value || 'auto';
  const carry = applyCarryoverOptions(profile);
  engine = new StoryEngine({ seed, genre, freedom, mode, complexity, readerMode, language: 'de', boosts: carry.boosts, explain: true, onEnd: (result) => {
          profile = applyRunResultToProfile(profile, result);
          renderProfile();
        }});
        engine.onUpdate((state) => {
          renderLog(state.log);
          renderChoices(state.choices);
          renderStatus(state);
        });
        engine.start();
      }

      els.startBtn.addEventListener('click', boot);
      els.actBtn.addEventListener('click', () => {
        const text = (els.freeInput.value || '').trim();
        if (!text) return;
        engine?.next({ type: 'free', text });
        els.freeInput.value = '';
      });
      els.saveBtn.addEventListener('click', () => {
        if (!engine) return;
        const save = engine.save();
        localStorage.setItem('ki-story-weber-save', JSON.stringify(save));
      });
      els.loadBtn.addEventListener('click', () => {
        const raw = localStorage.getItem('ki-story-weber-save');
        if (!raw) return;
        try {
          const data = JSON.parse(raw);
          els.freedom.value = String(Math.round((data.freedom ?? 0.4)*100));
          engine = new StoryEngine({ seed: data.seed, genre: data.genre, freedom: data.freedom, mode: data.mode, complexity: data.complexity, readerMode: data.readerMode, language: data.language });
          engine.onUpdate((state) => {
            renderLog(state.log);
            renderChoices(state.choices);
            renderStatus(state);
          });
          engine.load(data);
        } catch (e) {
          console.error('Laden fehlgeschlagen', e);
        }
      });
      els.resetBtn.addEventListener('click', () => {
        engine = null;
        els.story.innerHTML = '';
        els.choices.innerHTML = '';
        document.title = 'KI Story-Weber – Interaktives Erzählen';
      });

      // AI co-player buttons
      els.aiSuggestBtn.addEventListener('click', () => {
        renderInsights();
      });
      els.aiAutoBtn.addEventListener('click', () => {
        const s = engine?.getInsights?.();
        if (s?.suggestion) {
          engine.next({ type: 'choice', index: s.suggestion.index });
        }
      });

      // profile buttons
      els.exportBtn.addEventListener('click', () => exportProfile());
      els.importInput.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        profile = await importProfile(file);
        renderProfile();
      });
      els.resetProfileBtn.addEventListener('click', () => { resetProfile(); profile = loadProfile(); renderProfile(); });

      // initial render
  renderProfile();
  const updateFreedomLabel = () => { els.freedomVal.textContent = `${els.freedom.value}%`; };
  els.freedom.addEventListener('input', updateFreedomLabel);
  updateFreedomLabel();
    </script>
  </body>
  </html>
